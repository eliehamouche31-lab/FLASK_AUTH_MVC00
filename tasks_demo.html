<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tasks Demo</title>
<style>
table { border-collapse: collapse; width: 70%; margin: 20px auto; }
th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
tr.cursor { background-color: #d0e7ff; }
td.editable input { width: 90%; }
button { margin: 2px; padding: 3px 6px; }
</style>
</head>
<body>

<h2 style="text-align:center;">Tasks Demo (CursorManager)</h2>

<table id="tasksTable">
  <thead>
    <tr>
      <th>ID</th>
      <th>Name</th>
      <th>Value</th>
      <th>Actions</th>
    </tr>
  </thead>
  <tbody id="tasksTableBody"></tbody>
</table>

<div style="text-align:center; margin:10px;">
  <button id="addTaskBtn">Add</button>
  <button id="cancelTaskBtn">Cancel</button>
</div>

<div style="text-align:center; margin-top:10px;">
  <button id="prevBtn">↑ Prev</button>
  <button id="nextBtn">↓ Next</button>
  <button id="firstBtn">First</button>
  <button id="lastBtn">Last</button>
</div>

<script src="static/js/CursorManager.js"></script>
<script>
// ---------------------
// Initialization
// ---------------------
const pageId = 'tasks';
CursorManager.init(pageId, 'tasksTable', '#tasksTableBody');

// ---------------------
// Fetch tasks from server
// ---------------------
function fetchTasks() {
    fetch('/api/tasks')
        .then(res => res.json())
        .then(data => renderTasks(data));
}

// Render tasks table
function renderTasks(tasks) {
    const tbody = document.getElementById('tasksTableBody');
    tbody.innerHTML = '';
    tasks.forEach(task => {
        const tr = document.createElement('tr');
        tr.dataset.id = task.id;
        tr.innerHTML = `
            <td class="editable" data-key="id">${task.id}</td>
            <td class="editable" data-key="name">${task.name}</td>
            <td class="editable" data-key="value">${task.value}</td>
            <td>
                <button class="update-btn">Update</button>
                <button class="delete-btn">Delete</button>
                <button class="cancel-btn">Cancel</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
    CursorManager.syncRows(pageId);
    const firstId = CursorManager.getFirstRowId(pageId);
    if(firstId) CursorManager.setCursor(pageId, firstId);
}

// ---------------------
// Row-level buttons
// ---------------------
document.getElementById('tasksTableBody').addEventListener('click', e => {
    const tr = e.target.closest('tr');
    if(!tr) return;
    const rowId = tr.dataset.id;
    CursorManager.setCursor(pageId, rowId);

    if(e.target.classList.contains('update-btn')){
        CursorManager.beginEdit(pageId, rowId);
        // Auto-commit to server on blur or save (example)
        tr.querySelectorAll('td.editable input').forEach(input => {
            input.addEventListener('blur', () => {
                const name = tr.querySelector('td[data-key="name"] input').value;
                const value = tr.querySelector('td[data-key="value"] input').value;
                fetch(`/api/tasks/${rowId}`, {
                    method: 'PUT',
                    headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({name, value})
                }).then(fetchTasks);
                CursorManager.commitEdit(pageId, rowId, {name, value});
            }, {once:true});
        });
    }

    if(e.target.classList.contains('delete-btn')){
        fetch(`/api/tasks/${rowId}`, {method:'DELETE'})
            .then(fetchTasks);
    }

    if(e.target.classList.contains('cancel-btn')){
        CursorManager.cancelPageAction(pageId);
        fetchTasks();
    }
});

// ---------------------
// Table-level buttons
// ---------------------
document.getElementById('addTaskBtn').addEventListener('click', () => {
    CursorManager.beginAdd(pageId);
});

document.getElementById('cancelTaskBtn').addEventListener('click', () => {
    CursorManager.cancelPageAction(pageId);
    fetchTasks();
});

// ---------------------
// Navigation buttons
// ---------------------
document.getElementById('prevBtn').addEventListener('click', () => CursorManager.moveCursorUp(pageId));
document.getElementById('nextBtn').addEventListener('click', () => CursorManager.moveCursorDown(pageId));
document.getElementById('firstBtn').addEventListener('click', () => {
    const id = CursorManager.getFirstRowId(pageId);
    if(id) CursorManager.setCursor(pageId, id);
});
document.getElementById('lastBtn').addEventListener('click', () => {
    const id = CursorManager.getLastRowId(pageId);
    if(id) CursorManager.setCursor(pageId, id);
});

// ---------------------
// Keyboard shortcuts
// ---------------------
document.addEventListener('keydown', e => {
    switch(e.key){
        case 'ArrowUp': CursorManager.moveCursorUp(pageId); e.preventDefault(); break;
        case 'ArrowDown': CursorManager.moveCursorDown(pageId); e.preventDefault(); break;
        case 'Home':
            const first = CursorManager.getFirstRowId(pageId);
            if(first) CursorManager.setCursor(pageId, first); e.preventDefault(); break;
        case 'End':
            const last = CursorManager.getLastRowId(pageId);
            if(last) CursorManager.setCursor(pageId, last); e.preventDefault(); break;
        case 'Delete':
            const cursorId = CursorManager.getCursor(pageId);
            if(cursorId){
                fetch(`/api/tasks/${cursorId}`, {method:'DELETE'}).then(fetchTasks);
                CursorManager.deleteAtCursor(pageId);
            }
            e.preventDefault(); break;
        case 'Escape':
            CursorManager.cancelPageAction(pageId); fetchTasks(); e.preventDefault(); break;
    }
});

// Initial load
fetchTasks();
</script>
</body>
</html>
 