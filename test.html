<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Test CursorManager</title>
<style>
  table { border-collapse: collapse; width: 70%; margin: 20px auto; }
  th, td { border: 1px solid #528582; padding: 6px; text-align: center; }
  tr.cursor { background-color: #aaa; }
  input { width: 90%; }
  button { margin: 2px; padding: 3px 6px; }
</style>
</head>
<body>

<h2 style="text-align:center;">CursorManager Test Table</h2>

<table id="table1">
  <thead>
    <tr><th>ID</th><th>Name</th><th>Value</th><th>Actions</th></tr>
  </thead>
  <tbody></tbody>
</table>

<div style="text-align:center; margin-top:10px;">
  <button id="btn-add">Add</button>
  <button id="btn-prev">↑ Prev</button>
  <button id="btn-next">↓ Next</button>
  <button id="btn-first">First</button>
  <button id="btn-last">Last</button>
</div>

<script src="static/js/CursorManager.js"></script>
<script>
const PAGE = 'page1';
const tbody = document.querySelector('#table1 tbody');

let data = [
  {id:1,name:'Alice',value:10},
  {id:2,name:'Bob',value:20},
  {id:3,name:'Charlie',value:30},
  {id:4,name:'Diana',value:40},
  {id:5,name:'Oliver',value:50}
];

CursorManager.init(PAGE);
data.forEach(d => CursorManager.registerRow(PAGE,String(d.id)));

// --- Render ---
function renderRows(){
  tbody.innerHTML='';
  const state = CursorManager.getState(PAGE);
  state.rows.forEach(rowId=>{
    const existing = data.find(d=>String(d.id)===String(rowId));
    const rowData = existing || {id:rowId,name:'',value:''};
    const tr = document.createElement('tr');
    tr.dataset.id=rowId;
    tr.innerHTML=`
      <td><input value="${rowData.id}" disabled></td>
      <td><input value="${rowData.name}" disabled></td>
      <td><input value="${rowData.value}" disabled></td>
      <td>
        <button class="update-btn">Update</button>
        <button class="save-btn" hidden>Save</button>
        <button class="cancel-btn" hidden>Cancel</button>
        <button class="delete-btn">Delete</button>
        <button class="cancel-btn">Annuler</button>
      </td>`;
    tbody.appendChild(tr);
  });
  renderTable();
}

function renderTable() {
  const state = CursorManager.getState(PAGE);
  if (!state) return;

  // Si aucun curseur défini en mode view, positionne sur la première ligne
  if (!state.cursorRowId && state.rows.length > 0) {
    CursorManager.setCursor(PAGE, state.rows[0]);
    return; // render sera rappelé après setCursor
  }

  tbody.querySelectorAll('tr').forEach(tr => {
    const rowId = tr.dataset.id;
    const isCursor = String(rowId) === String(state.cursorRowId);
    const inputs = tr.querySelectorAll('input');
    const updateBtn = tr.querySelector('.update-btn');
    const cancelBtn = tr.querySelector('.cancel-btn');
    const deleteBtn = tr.querySelector('.delete-btn');

    // Toujours surligner la ligne du curseur
    tr.classList.toggle('cursor', isCursor);

    if (isCursor && (state.mode === 'edit' || state.mode === 'add')) {
      // Mode édition ou ajout
      inputs.forEach(i => i.disabled = false);
      updateBtn.disabled = true;
      cancelBtn.disabled = false;
      deleteBtn.disabled = true;
      inputs[0].focus(); // curseur sur 1ère colonne
    } else {
      // Mode view
      inputs.forEach(i => i.disabled = true);
      updateBtn.disabled = false;
      cancelBtn.disabled = true;
      deleteBtn.disabled = false;
    }
  });
}

// --- CursorManager change listener ---
CursorManager.onChange(()=>renderTable());

// --- Row buttons ---
tbody.addEventListener('click', e=>{
  const tr = e.target.closest('tr');
  if(!tr) return;
  const rowId = tr.dataset.id;

  if(e.target.classList.contains('update-btn')){
    CursorManager.setCursor(PAGE,rowId);
    CursorManager.intent(PAGE,'edit');

  }else if(e.target.classList.contains('cancel-btn')){
    CursorManager.setCursor(PAGE,rowId);
    CursorManager.intent(PAGE,'view'); // annule la modification
    renderTable(); 

  } else if(e.target.classList.contains('save-btn')){
    // save data
    const inputs = tr.querySelectorAll('input');
    const idx = data.findIndex(d=>String(d.id)===String(rowId));
    if(idx>=0){
      data[idx].name = inputs[1].value;
      data[idx].value = inputs[2].value;
    } else {
      data.push({id:rowId,name:inputs[1].value,value:inputs[2].value});
    }
    CursorManager.intent(PAGE,'view');

  } else if(e.target.classList.contains('cancel-btn')){
    CursorManager.intent(PAGE,'view');
  }else if(e.target.classList.contains('delete-btn')){
    CursorManager.setCursor(PAGE,rowId);
    CursorManager.deleteRow(PAGE);
    // supprimer du DOM
    const tr = tbody.querySelector(`tr[data-id='${rowId}']`);
    if(tr) tr.remove();
    // supprimer du data array
    const idx = data.findIndex(d=>String(d.id)===String(rowId));
    if(idx>=0) data.splice(idx,1);
    renderTable(); // <-- important
  }
});

// --- Table-level buttons ---
document.getElementById('btn-add').addEventListener('click',()=>{
  const newId = CursorManager.addRow(PAGE);
  renderRows();
});

document.getElementById('btn-prev').addEventListener('click', () => {
  const state = CursorManager.getState(PAGE);
  if (state.mode === 'view') CursorManager.moveCursorUp(PAGE);
});

document.getElementById('btn-next').addEventListener('click', () => {
  const state = CursorManager.getState(PAGE);
  if (state.mode === 'view') CursorManager.moveCursorDown(PAGE);
});

document.getElementById('btn-first').addEventListener('click', () => {
  const state = CursorManager.getState(PAGE);
  if (state.mode === 'view' && state.rows.length) {
    CursorManager.setCursor(PAGE, state.rows[0]);
  }
});

document.getElementById('btn-last').addEventListener('click', () => {
  const state = CursorManager.getState(PAGE);
  if (state.mode === 'view' && state.rows.length) {
    CursorManager.setCursor(PAGE, state.rows[state.rows.length-1]);
  }
});

// --- Initial render ---
renderRows();

</script>
</body>
</html>
 
